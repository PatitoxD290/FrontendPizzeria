<div class="combo-form-container">
  
  <!-- Encabezado -->
  <div class="dialog-header">
    <h2 mat-dialog-title class="m-0">
      <mat-icon class="header-icon">fastfood</mat-icon>
      {{ comboData.ID_Combo ? 'Editar Combo' : 'Crear Nuevo Combo' }}
    </h2>
    <button mat-icon-button (click)="onCancelar()">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <mat-dialog-content class="dialog-content">
    <form class="combo-form">
      
      <!-- SECCIÓN 1: Información Básica -->
      <div class="form-section">
        <h3 class="section-title">Información General</h3>
        
        <div class="row">
          <mat-form-field appearance="outline" class="col-md-8 w-100">
            <mat-label>Nombre del Combo</mat-label>
            <input matInput [(ngModel)]="comboData.Nombre" name="nombre" required placeholder="Ej: Combo Familiar">
            <mat-error>El nombre es obligatorio</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="col-md-4 w-100">
            <mat-label>Precio</mat-label>
            <input matInput type="number" [(ngModel)]="comboData.Precio" name="precio" required min="0">
            <span matPrefix>S/.&nbsp;</span>
            <mat-hint>Sugerido: S/. {{ (comboData.Precio * 1).toFixed(2) }}</mat-hint>
          </mat-form-field>
        </div>

        <mat-form-field appearance="outline" class="w-100">
          <mat-label>Descripción</mat-label>
          <textarea matInput [(ngModel)]="comboData.Descripcion" name="descripcion" rows="2" placeholder="Describe qué incluye..."></textarea>
        </mat-form-field>

        <div class="d-flex gap-2 align-items-center mb-3">
          <button type="button" mat-stroked-button color="primary" (click)="calcularPrecioAutomatico()" 
                  matTooltip="Calcula el precio sumando los productos con un 15% de descuento"
                  [disabled]="comboData.detalles.length === 0">
            <mat-icon>calculate</mat-icon> Calcular Precio Sugerido
          </button>
        </div>
      </div>

      <!-- SECCIÓN 2: Imagen -->
      <div class="form-section">
        <h3 class="section-title">Imagen</h3>
        <div class="image-upload-container">
          <div class="upload-btn-wrapper">
            <button mat-stroked-button type="button" (click)="fileInput.click()">
              <mat-icon>cloud_upload</mat-icon> Seleccionar Imagen
            </button>
            <input #fileInput type="file" id="fileInput" (change)="onFileSelected($event)" accept="image/*" hidden>
          </div>
          
          <div *ngIf="imagePreview" class="image-preview">
            <img [src]="imagePreview" alt="Vista previa">
            <button mat-icon-button color="warn" class="remove-btn" (click)="removeImage()">
              <mat-icon>delete</mat-icon>
            </button>
          </div>
        </div>
      </div>

      <!-- SECCIÓN 3: Selección de Productos -->
      <div class="form-section products-section">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h3 class="section-title m-0">Agregar Productos</h3>
          <!-- Filtros rápidos -->
          <div class="filters d-flex gap-2">
            <mat-form-field appearance="outline" class="dense-field" style="width: 150px;">
              <mat-label>Categoría</mat-label>
              <mat-select [(ngModel)]="categoriaFiltro" (selectionChange)="filtrarProductos()" name="catFilter">
                <mat-option [value]="0">Todas</mat-option>
                <mat-option *ngFor="let c of categorias" [value]="c.ID_Categoria_P">{{ c.Nombre }}</mat-option>
              </mat-select>
            </mat-form-field>
            <mat-form-field appearance="outline" class="dense-field">
              <mat-label>Buscar...</mat-label>
              <input matInput [(ngModel)]="terminoBusqueda" (keyup)="filtrarProductos()" name="search">
              <mat-icon matSuffix>search</mat-icon>
            </mat-form-field>
          </div>
        </div>

        <!-- Grid de Productos -->
        <div class="products-grid-container">
          <div *ngIf="cargando" class="spinner-center">
            <mat-spinner diameter="40"></mat-spinner>
          </div>

          <div class="products-grid" *ngIf="!cargando">
            <div *ngFor="let producto of productosFiltrados" class="product-card mat-elevation-z1">
              <div class="card-header">
                <span class="prod-name">{{ producto.Nombre }}</span>
                <span class="cat-badge">{{ getNombreCategoria(producto.ID_Categoria_P) }}</span>
              </div>
              <div class="tamanos-list">
                <div *ngFor="let t of getTamanosActivos(producto)" class="tamano-row">
                  <span class="t-name">{{ t.nombre_tamano }}</span>
                  <span class="t-price">S/. {{ t.Precio }}</span>
                  <button mat-mini-fab color="accent" class="add-mini-btn" 
                          (click)="agregarProductoYCalcular(t, producto)"
                          matTooltip="Agregar al combo">
                    <mat-icon>add</mat-icon>
                  </button>
                </div>
              </div>
            </div>
            <div *ngIf="productosFiltrados.length === 0" class="no-data">
              No se encontraron productos.
            </div>
          </div>
        </div>
      </div>

      <!-- SECCIÓN 4: Resumen del Combo (Carrito) -->
      <div class="form-section summary-section">
        <h3 class="section-title">Contenido del Combo</h3>
        
        <div class="selected-list" *ngIf="comboData.detalles.length > 0; else emptyCombo">
          <div *ngFor="let detalle of comboData.detalles; let i = index" class="selected-item">
            <div class="item-info">
              <div class="fw-bold">{{ detalle.Producto_Nombre }}</div>
              <div class="text-muted small">{{ detalle.Tamano_Nombre }}</div>
            </div>
            
            <div class="item-actions">
              <button mat-icon-button (click)="actualizarCantidadYCalcular(detalle, detalle.Cantidad - 1)">
                <mat-icon>remove_circle_outline</mat-icon>
              </button>
              <span class="qty-badge">{{ detalle.Cantidad }}</span>
              <button mat-icon-button (click)="actualizarCantidadYCalcular(detalle, detalle.Cantidad + 1)">
                <mat-icon>add_circle_outline</mat-icon>
              </button>
              <button mat-icon-button color="warn" (click)="removerProductoYCalcular(i)">
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          </div>
        </div>

        <ng-template #emptyCombo>
          <div class="empty-state">
            <mat-icon>shopping_basket</mat-icon>
            <p>Agrega productos de la lista superior</p>
          </div>
        </ng-template>
      </div>

    </form>
  </mat-dialog-content>

  <mat-dialog-actions align="end" class="dialog-actions">
    <button mat-button (click)="onCancelar()">Cancelar</button>
    <button mat-flat-button color="primary" (click)="onGuardar()" 
            [disabled]="guardando || comboData.detalles.length === 0 || !comboData.Nombre">
      <mat-icon *ngIf="!guardando">save</mat-icon>
      <mat-spinner *ngIf="guardando" diameter="20" class="me-2"></mat-spinner>
      {{ guardando ? 'Guardando...' : 'Guardar Combo' }}
    </button>
  </mat-dialog-actions>
</div>