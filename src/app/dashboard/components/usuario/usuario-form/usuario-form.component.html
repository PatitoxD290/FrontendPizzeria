<h2 mat-dialog-title class="d-flex align-items-center">
  <mat-icon class="me-2 text-primary">{{ mode === 'password' ? 'lock_reset' : 'person' }}</mat-icon>
  {{ mode === 'password' ? 'Cambiar Contraseña' : (usuario.ID_Usuario ? 'Editar Usuario' : 'Nuevo Usuario') }}
</h2>

<mat-dialog-content class="dialog-content">
  <form #form="ngForm" (ngSubmit)="saveUsuario()">
    
    <!-- MODO: FORMULARIO DE DATOS -->
    <ng-container *ngIf="mode === 'form'">
      
      <div class="form-container">
        <!-- Perfil (Nombre) -->
        <mat-form-field appearance="outline" class="w-100">
          <mat-label>Nombre Completo</mat-label>
          <input matInput 
                 type="text" 
                 [(ngModel)]="usuario.Perfil" 
                 name="Perfil" 
                 required
                 (keydown)="soloLetras($event)"
                 (input)="formatNombreCompleto()"
                 placeholder="Ej: Juan Perez">
          <mat-icon matSuffix>badge</mat-icon>
          <mat-error>Requerido</mat-error>
        </mat-form-field>

        <!-- Correo -->
        <mat-form-field appearance="outline" class="w-100">
          <mat-label>Correo Electrónico</mat-label>
          <input matInput 
                 type="email" 
                 [(ngModel)]="usuario.Correo" 
                 name="Correo" 
                 required
                 email
                 placeholder="usuario@empresa.com">
          <mat-icon matSuffix>email</mat-icon>
          <mat-error>Correo inválido o requerido</mat-error>
        </mat-form-field>

        <!-- Rol y Estado -->
        <div class="row">
          <mat-form-field appearance="outline" class="col-6">
            <mat-label>Rol</mat-label>
            <mat-select [(ngModel)]="usuario.Roll" name="Roll" required>
              <mat-option value="A">Administrador</mat-option>
              <mat-option value="E">Empleado</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" class="col-6">
            <mat-label>Estado</mat-label>
            <mat-select [(ngModel)]="usuario.Estado" name="Estado" required>
              <mat-option value="A">Activo</mat-option>
              <mat-option value="I">Inactivo</mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <!-- Password (Solo al crear nuevo) -->
        <div *ngIf="usuario.ID_Usuario === 0" class="password-section mt-2">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Contraseña</mat-label>
            <input matInput 
                   [type]="hidePassword ? 'password' : 'text'" 
                   [(ngModel)]="usuario.Password" 
                   name="Password" 
                   required 
                   minlength="4">
            <button mat-icon-button matSuffix type="button" (click)="hidePassword = !hidePassword">
              <mat-icon>{{ hidePassword ? 'visibility_off' : 'visibility' }}</mat-icon>
            </button>
            <mat-hint>Mínimo 4 caracteres</mat-hint>
            <mat-error>Requerido</mat-error>
          </mat-form-field>
        </div>
      </div>

    </ng-container>

    <!-- MODO: SOLO CONTRASEÑA -->
    <ng-container *ngIf="mode === 'password'">
      <div class="password-container py-3">
        <p class="text-secondary mb-3">Ingresa la nueva contraseña para el usuario <strong>{{ usuario.Perfil }}</strong>.</p>
        
        <mat-form-field appearance="outline" class="w-100">
          <mat-label>Nueva Contraseña</mat-label>
          <input matInput 
                 [type]="hidePassword ? 'password' : 'text'" 
                 [(ngModel)]="usuario.Password" 
                 name="Password" 
                 required
                 minlength="4">
          <button mat-icon-button matSuffix type="button" (click)="hidePassword = !hidePassword">
            <mat-icon>{{ hidePassword ? 'visibility_off' : 'visibility' }}</mat-icon>
          </button>
          <mat-error>Mínimo 4 caracteres</mat-error>
        </mat-form-field>
      </div>
    </ng-container>

  </form>
</mat-dialog-content>

<mat-dialog-actions align="end" class="dialog-actions">
  <button mat-button (click)="close()">Cancelar</button>
  <button mat-flat-button color="primary" (click)="saveUsuario()" 
          [disabled]="!form.valid || guardando">
    <mat-icon *ngIf="!guardando">save</mat-icon>
    <mat-spinner *ngIf="guardando" diameter="20" class="me-2 d-inline-block"></mat-spinner>
    Guardar
  </button>
</mat-dialog-actions>