<div class="container-fluid p-4">
  
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="mat-headline-5 mb-0">Pedidos en Cocina / Barra</h1>
      <p class="text-secondary mb-0">Gestión de colas y tiempos de espera</p>
    </div>
    <button mat-stroked-button color="primary" (click)="cargarPedidosEnEspera()" [disabled]="isLoading">
      <mat-icon [class.spin]="isLoading">refresh</mat-icon> Actualizar
    </button>
  </div>

  <!-- Loading -->
  <div *ngIf="isLoading" class="loading-container">
    <mat-spinner diameter="50"></mat-spinner>
    <p class="mt-3 text-secondary">Cargando pedidos...</p>
  </div>

  <!-- Empty State -->
  <div *ngIf="!isLoading && pedidos.length === 0" class="empty-state">
    <mat-icon class="empty-icon">check_circle_outline</mat-icon>
    <h3>¡Sin pedidos pendientes!</h3>
    <p>Todo ha sido despachado.</p>
  </div>

  <!-- Grid -->
  <div *ngIf="!isLoading && pedidos.length > 0" class="orders-grid">
    
    <mat-card *ngFor="let p of pedidosPaginados" class="order-card">
      
      <!-- Header (Color según tiempo) -->
      <div class="order-header" [class.critical]="esTiempoCritico(p.Fecha_Registro, p.Hora_Pedido)">
        <div class="d-flex justify-content-between w-100">
          <div>
            <h3 class="order-id">#{{ p.ID_Pedido }}</h3>
            <span class="client-name">{{ getNombreCliente(p) }}</span>
          </div>
          <div class="text-end">
            <div class="time-badge">
              <mat-icon>timer</mat-icon> {{ getTiempoEspera(p.Fecha_Registro, p.Hora_Pedido) }}
            </div>
            <div class="order-time">{{ getHoraFormateada(p.Hora_Pedido) }}</div>
          </div>
        </div>
      </div>

      <mat-divider></mat-divider>

      <!-- Body -->
      <mat-card-content class="order-content">
        
        <!-- Notas -->
        <div *ngIf="p.Notas" class="order-notes">
          <mat-icon>campaign</mat-icon> 
          <span>{{ p.Notas }}</span>
        </div>

        <!-- Items -->
        <div class="items-list custom-scrollbar">
          <div *ngFor="let d of p.detallesCompletos" class="item-row">
            <span class="item-qty">{{ d.Cantidad }}</span>
            <div class="item-desc">
              <span class="item-name">
                {{ d.productoInfo?.Nombre || d.Nombre_Producto || d.Nombre_Combo || 'Item' }}
              </span>
              <span class="item-meta">
                {{ d.ID_Combo ? '(Combo)' : d.tamanoInfo }}
              </span>
            </div>
          </div>
        </div>

        <div class="order-total">
          Total: S/ {{ p.SubTotal | number:'1.2-2' }}
        </div>
      </mat-card-content>

      <!-- Actions -->
      <mat-card-actions class="order-actions">
        <button mat-icon-button color="warn" 
                (click)="cambiarEstado(p, 'C')"
                [disabled]="processingId === p.ID_Pedido"
                matTooltip="Cancelar">
          <mat-icon>block</mat-icon>
        </button>

        <button mat-flat-button color="primary" class="btn-entregar"
                (click)="cambiarEstado(p, 'E')"
                [disabled]="processingId === p.ID_Pedido">
          <ng-container *ngIf="processingId !== p.ID_Pedido">
            <mat-icon>check_circle</mat-icon> LISTO
          </ng-container>
          <mat-spinner *ngIf="processingId === p.ID_Pedido" diameter="20" color="accent"></mat-spinner>
        </button>
      </mat-card-actions>

    </mat-card>
  </div>

  <mat-paginator [length]="pedidos.length"
                 [pageSize]="pageSize"
                 [pageSizeOptions]="pageSizeOptions"
                 (page)="onPageChange($event)"
                 [hidden]="pedidos.length === 0"
                 showFirstLastButtons>
  </mat-paginator>

</div>