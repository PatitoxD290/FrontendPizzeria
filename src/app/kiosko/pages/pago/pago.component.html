<div class="pago-container">

  <!-- ðŸ”„ LOADING OVERLAY -->
  <div class="loading-overlay" *ngIf="procesando">
    <mat-spinner diameter="60" color="accent"></mat-spinner>
    <h3>Procesando su pedido...</h3>
  </div>

  <!-- âœ… PANTALLA FINAL (Ã‰XITO) -->
  <div class="pantalla-final" *ngIf="pasoActual === 'final'">
    <div class="success-content">
      <mat-icon class="icon-success">check_circle</mat-icon>
      <h1>Â¡Pedido Confirmado!</h1>
      
      <div class="ticket-visual">
        <p class="label">TU NÃšMERO DE PEDIDO</p>
        <p class="code">{{ codigoPedidoGenerado }}</p>
      </div>

      <p class="instruction">Por favor, recoge tu comprobante y espera tu llamado.</p>
      
      <button mat-flat-button color="primary" class="btn-inicio" (click)="volverInicio()">
        <mat-icon>home</mat-icon> Volver al Inicio
      </button>
    </div>
  </div>

  <!-- 1ï¸âƒ£ PASO 1: SELECCIÃ“N DE PAGO -->
  <div class="paso-content" *ngIf="pasoActual === 'pago' && !selectedMetodoPago">
    <h2 class="titulo-paso">Â¿CÃ³mo deseas pagar?</h2>
    <h3 class="monto-total">Total: S/ {{ total | number:'1.2-2' }}</h3>

    <div class="metodos-grid">
      <button mat-raised-button class="metodo-btn" (click)="seleccionarMetodo(TIPO_PAGO.EFECTIVO)">
        <mat-icon class="icon-grande">payments</mat-icon>
        <span>Efectivo</span>
      </button>
      
      <button mat-raised-button class="metodo-btn" (click)="seleccionarMetodo(TIPO_PAGO.TARJETA)">
        <mat-icon class="icon-grande">credit_card</mat-icon>
        <span>Tarjeta</span>
      </button>
      
      <button mat-raised-button class="metodo-btn" (click)="seleccionarMetodo(TIPO_PAGO.BILLETERA)">
        <mat-icon class="icon-grande">qr_code_2</mat-icon>
        <span>Yape / Plin</span>
      </button>
    </div>

    <button mat-stroked-button color="warn" class="btn-volver" routerLink="/kiosko/carrito">
      <mat-icon>arrow_back</mat-icon> Volver al Carrito
    </button>
  </div>

  <!-- 1.1 PAGO EN EFECTIVO (Calculadora) -->
  <div class="paso-content" *ngIf="pasoActual === 'pago' && selectedMetodoPago === TIPO_PAGO.EFECTIVO">
    <h2 class="titulo-paso">Pago en Efectivo</h2>
    
    <div class="display-pago">
      <div class="info-row">
        <span>Total a Pagar:</span>
        <strong>S/ {{ total | number:'1.2-2' }}</strong>
      </div>
      <div class="info-row big">
        <span>Recibido:</span>
        <span class="input-simulado">S/ {{ recibeString || '0.00' }}</span>
      </div>
      <div class="info-row highlight">
        <span>Vuelto:</span>
        <span>S/ {{ vuelto | number:'1.2-2' }}</span>
      </div>
    </div>

    <div class="numpad">
      <button *ngFor="let n of [1,2,3,4,5,6,7,8,9]" (click)="addNumber(n.toString())">{{ n }}</button>
      <button (click)="addDecimal()">.</button>
      <button (click)="addNumber('0')">0</button>
      <button (click)="deleteLast()" class="btn-del"><mat-icon>backspace</mat-icon></button>
    </div>

    <div class="actions">
      <button mat-button color="warn" (click)="selectedMetodoPago = null">Cancelar</button>
      <button mat-flat-button color="primary" class="btn-next" 
              (click)="confirmarPagoEfectivo()"
              [disabled]="montoRecibido < total">
        Continuar <mat-icon>arrow_forward</mat-icon>
      </button>
    </div>
  </div>

  <!-- 1.2 VERIFICACIÃ“N CÃ“DIGO (Simulado para Tarjeta/Yape) -->
  <div class="paso-content" *ngIf="solicitandoCodigo">
    <h2 class="titulo-paso">Procesando Pago</h2>
    <p class="text-center">Sigue las instrucciones en el POS o tu celular.</p>
    
    <div class="simulacion-box">
      <mat-spinner diameter="40" color="primary"></mat-spinner>
      <p>Esperando confirmaciÃ³n...</p>
      <button mat-stroked-button (click)="verificarCodigoSimulado()">Simular Pago Exitoso</button>
    </div>

    <button mat-button color="warn" (click)="cancelarVerificacion()">Cancelar OperaciÃ³n</button>
  </div>

  <!-- 2ï¸âƒ£ PASO 2: COMPROBANTE -->
  <div class="paso-content" *ngIf="pasoActual === 'comprobante'">
    <h2 class="titulo-paso">Selecciona Comprobante</h2>

    <div class="comprobantes-grid">
      <button mat-raised-button class="comp-btn" (click)="seleccionarComprobante(TIPO_VENTA.NOTA)">
        <mat-icon>receipt_long</mat-icon>
        <span>Sin Comprobante</span>
        <small>(Nota de Venta)</small>
      </button>
      
      <button mat-raised-button class="comp-btn" (click)="seleccionarComprobante(TIPO_VENTA.BOLETA)">
        <mat-icon>description</mat-icon>
        <span>Boleta</span>
        <small>DNI</small>
      </button>
      
      <button mat-raised-button class="comp-btn" (click)="seleccionarComprobante(TIPO_VENTA.FACTURA)">
        <mat-icon>business</mat-icon>
        <span>Factura</span>
        <small>RUC</small>
      </button>
    </div>
  </div>

  <!-- 3ï¸âƒ£ PASO 3: DOCUMENTO -->
  <div class="paso-content" *ngIf="pasoActual === 'documento'">
    <h2 class="titulo-paso">Ingrese {{ tipoDocumento }}</h2>
    
    <div class="display-pago">
      <span class="input-simulado">{{ numeroDocumento || 'Ingrese nÃºmero' }}</span>
    </div>

    <div class="numpad">
      <button *ngFor="let n of [1,2,3,4,5,6,7,8,9]" (click)="addDocNumber(n.toString())">{{ n }}</button>
      <button disabled></button>
      <button (click)="addDocNumber('0')">0</button>
      <button (click)="deleteDocLast()" class="btn-del"><mat-icon>backspace</mat-icon></button>
    </div>

    <div class="actions">
      <button mat-button (click)="pasoActual = 'comprobante'">AtrÃ¡s</button>
      <button mat-flat-button color="primary" class="btn-next" 
              (click)="confirmarDocumento()"
              [disabled]="numeroDocumento.length < 8">
        Confirmar
      </button>
    </div>
  </div>

</div>