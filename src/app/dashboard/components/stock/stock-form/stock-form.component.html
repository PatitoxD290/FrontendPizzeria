<h2 mat-dialog-title class="d-flex align-items-center">
  <mat-icon class="me-2 text-primary">swap_vert</mat-icon>
  {{ isFromSpecificRecord ? 'Registrar Movimiento' : 'Nuevo Movimiento' }}
</h2>

<mat-dialog-content class="pt-2">
  <form [formGroup]="movimientoForm" (ngSubmit)="onSubmit()">
    
    <!-- 1. Selección de Insumo (Solo si no viene pre-seleccionado) -->
    <div class="form-section" *ngIf="!isFromSpecificRecord">
      <mat-form-field appearance="outline" class="w-100">
        <mat-label>Buscar Insumo</mat-label>
        <input type="text" matInput formControlName="insumoNombre" [matAutocomplete]="auto"
               placeholder="Ej: Harina, Leche..." required>
        <mat-icon matSuffix>search</mat-icon>
        <mat-autocomplete #auto="matAutocomplete" (optionSelected)="onInsumoSelected($event)">
          <mat-option *ngFor="let insumo of filteredInsumos | async" [value]="insumo.Nombre">
            <div class="d-flex justify-content-between align-items-center">
              <span class="fw-medium">{{ insumo.Nombre }}</span>
              <span class="small text-muted">{{ insumo.Unidad_Med }}</span>
            </div>
          </mat-option>
        </mat-autocomplete>
        <mat-error>Debe seleccionar un insumo</mat-error>
      </mat-form-field>
    </div>

    <!-- Información del Insumo Seleccionado -->
    <div *ngIf="selectedInsumo" class="info-box mb-3">
      <div class="d-flex align-items-center">
        <mat-icon class="me-2 text-secondary">inventory_2</mat-icon>
        <div>
          <h6 class="m-0 text-primary">{{ selectedInsumo.Nombre }}</h6>
          <small class="text-muted">Unidad: {{ selectedInsumo.Unidad_Med }} | Categoría: {{ selectedInsumo.Nombre_Categoria || '---' }}</small>
        </div>
      </div>
    </div>

    <!-- 2. Selección de Lote (Stock) -->
    <mat-form-field appearance="outline" class="w-100" *ngIf="stocksDisponibles.length > 0">
      <mat-label>Seleccionar Lote de Stock</mat-label>
      <mat-select formControlName="ID_Stock" (selectionChange)="onStockSelected($event.value)">
        <mat-option *ngFor="let s of stocksDisponibles" [value]="s.ID_Stock">
          Lote #{{ s.ID_Stock }} (Entrada: {{ s.Fecha_Entrada | date:'shortDate' }}) 
          - Disp: <strong>{{ s.Cantidad_Recibida }}</strong>
        </mat-option>
      </mat-select>
      <mat-error>Requerido</mat-error>
    </mat-form-field>

    <div *ngIf="selectedInsumo && stocksDisponibles.length === 0 && !loadingInsumos" class="alert alert-warning p-2">
      <small><mat-icon inline>warning</mat-icon> No hay lotes de stock activos para este insumo. Debe registrar una entrada primero.</small>
    </div>

    <!-- 3. Detalles del Movimiento -->
    <div class="row">
      <div class="col-md-6">
        <mat-form-field appearance="outline" class="w-100">
          <mat-label>Tipo Movimiento</mat-label>
          <mat-select formControlName="Tipo_Mov">
            <mat-option value="Entrada">Entrada (+)</mat-option>
            <mat-option value="Salida">Salida (-)</mat-option>
            <mat-option value="Ajuste">Ajuste (=)</mat-option>
          </mat-select>
        </mat-form-field>
      </div>

      <div class="col-md-6">
        <mat-form-field appearance="outline" class="w-100">
          <mat-label>Cantidad</mat-label>
          <input matInput type="number" formControlName="Cantidad" min="1">
          <span matSuffix class="ms-2 text-secondary">{{ selectedInsumo?.Unidad_Med }}</span>
          <mat-hint *ngIf="selectedStock && movimientoForm.get('Tipo_Mov')?.value === 'Salida'" class="text-danger">
            Máx: {{ selectedStock.Cantidad_Recibida }}
          </mat-hint>
          <mat-error>Requerido y mayor a 0</mat-error>
        </mat-form-field>
      </div>
    </div>

    <mat-form-field appearance="outline" class="w-100">
      <mat-label>Motivo / Observación</mat-label>
      <textarea matInput formControlName="Motivo" rows="2" placeholder="Ej: Merma, Compra extra, Ajuste de inventario..."></textarea>
    </mat-form-field>

    <!-- Usuario -->
    <div class="d-flex align-items-center justify-content-end text-muted small" *ngIf="usuarioLogueado">
      <mat-icon class="me-1" style="font-size: 16px; width: 16px; height: 16px;">person</mat-icon>
      Registra: {{ usuarioLogueado.Perfil || 'Usuario' }}
    </div>

  </form>
</mat-dialog-content>

<mat-dialog-actions align="end">
  <button mat-button (click)="onCancel()">Cancelar</button>
  <button mat-flat-button color="primary" (click)="onSubmit()" 
          [disabled]="movimientoForm.invalid || loading || stocksDisponibles.length === 0">
    <mat-icon *ngIf="!loading">save</mat-icon>
    <mat-spinner *ngIf="loading" diameter="20" class="me-2 d-inline-block"></mat-spinner>
    Registrar
  </button>
</mat-dialog-actions>