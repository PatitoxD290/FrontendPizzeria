<div class="container-fluid p-4">
  
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4 header-section">
    <div>
      <h1 class="mat-headline-5 mb-0">Gestión de Usuarios</h1>
      <p class="text-secondary mb-0">Administra los accesos y roles del sistema</p>
    </div>
    <button mat-flat-button color="primary" (click)="openNuevo()">
      <mat-icon>person_add</mat-icon>
      Nuevo Usuario
    </button>
  </div>

  <!-- Filtro -->
  <mat-form-field appearance="outline" class="w-100 search-field">
    <mat-label>Buscar usuario...</mat-label>
    <input matInput (keyup)="applyFilter($event)" placeholder="Nombre, correo, rol..." #input>
    <mat-icon matSuffix>search</mat-icon>
  </mat-form-field>

  <!-- Loading -->
  <div *ngIf="loading" class="loading-container">
    <mat-spinner diameter="50"></mat-spinner>
    <p class="mt-3">Cargando usuarios...</p>
  </div>

  <!-- Tabla -->
  <div class="mat-elevation-z8 table-container" [hidden]="loading">
    <table mat-table [dataSource]="dataSource" matSort>

      <!-- ID -->
      <ng-container matColumnDef="ID_Usuario">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> ID </th>
        <td mat-cell *matCellDef="let row" class="text-secondary"> {{row.ID_Usuario}} </td>
      </ng-container>

      <!-- Perfil (Nombre) -->
      <ng-container matColumnDef="Perfil">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Nombre Completo </th>
        <td mat-cell *matCellDef="let row" class="fw-medium"> 
          {{row.Perfil}} 
        </td>
      </ng-container>

      <!-- Correo -->
      <ng-container matColumnDef="Correo">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Correo / DNI </th>
        <td mat-cell *matCellDef="let row"> {{row.Correo}} </td>
      </ng-container>

      <!-- Rol -->
      <ng-container matColumnDef="Roll">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Rol </th>
        <td mat-cell *matCellDef="let row"> 
          <span [class]="'rol-badge ' + getRolClass(row.Roll)">
            {{ getRolText(row.Roll) }}
          </span>
        </td>
      </ng-container>

      <!-- Estado -->
      <ng-container matColumnDef="Estado">
        <th mat-header-cell *matHeaderCellDef class="text-center"> Estado </th>
        <td mat-cell *matCellDef="let row" class="text-center">
          <span [class]="'status-badge ' + getEstadoClass(row.Estado)">
            {{ getEstadoLabel(row.Estado) }}
          </span>
        </td>
      </ng-container>

      <!-- Fecha Registro -->
      <ng-container matColumnDef="Fecha_Registro">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Registrado </th>
        <td mat-cell *matCellDef="let row" class="text-muted"> {{row.Fecha_Registro | date:'dd/MM/yyyy'}} </td>
      </ng-container>

      <!-- Acciones -->
      <ng-container matColumnDef="acciones">
        <th mat-header-cell *matHeaderCellDef class="text-center"> Acciones </th>
        <td mat-cell *matCellDef="let row" class="text-center">
          
          <!-- Toggle Estado -->
          <button mat-icon-button 
                  [color]="row.Estado === 'A' ? 'warn' : 'accent'" 
                  (click)="toggleEstado(row)"
                  [matTooltip]="row.Estado === 'A' ? 'Desactivar acceso' : 'Activar acceso'">
            <mat-icon>{{ row.Estado === 'A' ? 'block' : 'check_circle' }}</mat-icon>
          </button>

          <!-- Editar Info -->
          <button mat-icon-button 
                  color="primary" 
                  (click)="openEditar(row)" 
                  [disabled]="!canEdit(row)"
                  matTooltip="Editar datos">
            <mat-icon>edit</mat-icon>
          </button>

          <!-- Cambiar Password -->
          <button mat-icon-button 
                  color="accent" 
                  (click)="openChangePassword(row)"
                  [disabled]="!canEdit(row)" 
                  matTooltip="Cambiar contraseña">
            <mat-icon>vpn_key</mat-icon>
          </button>

          <!-- Eliminar -->
          <button mat-icon-button 
                  color="warn" 
                  (click)="deleteUsuario(row)" 
                  [disabled]="!canDelete(row)"
                  matTooltip="Eliminar usuario">
            <mat-icon>delete</mat-icon>
          </button>

        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="hover-row"></tr>

      <!-- Sin resultados -->
      <tr class="mat-row" *matNoDataRow>
        <td class="mat-cell text-center py-4" colspan="7">
          No se encontraron usuarios que coincidan con "{{input.value}}"
        </td>
      </tr>
    </table>

    <mat-paginator [pageSizeOptions]="[5, 10, 20]" showFirstLastButtons aria-label="Seleccionar página"></mat-paginator>
  </div>
</div>