<h2 mat-dialog-title>
  {{ pedido.ID_Pedido ? 'Editar Pedido' : 'Nuevo Pedido' }}
</h2>

<mat-dialog-content>
  <form #form="ngForm" (ngSubmit)="savePedido()">

    <div class="pedido-container">
      <!-- üßç CLIENTE -->
      <div class="col cliente-col">
        <h3>Cliente</h3>

        <mat-checkbox [(ngModel)]="conCliente" name="conCliente">
          Registrar con datos de cliente
        </mat-checkbox>

        <div *ngIf="conCliente" class="mt-2">
          <button mat-flat-button color="accent" type="button" (click)="crearCliente()">
            Registrar datos
          </button>
        </div>

        <mat-form-field appearance="fill" class="w-full mt-3" *ngIf="conCliente">
          <mat-label>Cliente</mat-label>
          <mat-select [(ngModel)]="pedido.ID_Cliente" name="cliente_id" required>
            <mat-option *ngFor="let cliente of clientes" [value]="cliente.ID_Cliente">
              {{ cliente.Nombre }} {{ cliente.Apellido }}
            </mat-option>
          </mat-select>
        </mat-form-field>
      </div>

      <!-- üì¶ PRODUCTO -->
      <div class="col detalle-col">
        <h3>Agregar Producto</h3>

        <mat-form-field appearance="fill" class="w-full">
          <mat-label>Producto</mat-label>
          <mat-select [(ngModel)]="detalleTemporal.ID_Producto" name="producto_id" required>
            <mat-option *ngFor="let producto of productos" [value]="producto.ID_Producto">
              {{ producto.Nombre }} - S/ {{ producto.Precio_Base| number:'1.2-2' }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="fill" class="w-full">
          <mat-label>Cantidad</mat-label>
          <input matInput type="number" min="1"
                 [(ngModel)]="detalleTemporal.Cantidad"
                 name="cantidad" required>
        </mat-form-field>

        <button mat-flat-button color="primary" type="button" (click)="agregarDetalle()">
          Agregar al Pedido
        </button>
      </div>

      <!-- üí∞ DETALLE -->
      <div class="col resumen-col">
        <h3>Detalle del Pedido</h3>

        <table class="w-full mat-elevation-z2">
          <thead>
            <tr>
              <th>Producto</th>
              <th>Cant.</th>
              <th>Precio</th>
              <th>Acci√≥n</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let d of pedido.detalles; let i = index">
              <td>{{ getNombreProducto(d.ID_Producto) }}</td>
              <td>{{ d.Cantidad }}</td>
              <td>S/ {{ d.PrecioTotal | number:'1.2-2' }}</td>
              <td>
                <button mat-icon-button color="warn" type="button" (click)="eliminarDetalle(i)">
                  <mat-icon>delete</mat-icon>
                </button>
              </td>
            </tr>
            <tr *ngIf="!pedido.detalles?.length">
              <td colspan="4" class="text-center text-gray-500">Sin productos agregados</td>
            </tr>
          </tbody>
        </table>

        <div class="totales mt-3">
          <div class="flex justify-between">
            <span>Subtotal:</span>
            <strong>S/ {{ pedido.SubTotal | number:'1.2-2' }}</strong>
          </div>

          <div class="flex justify-between text-lg font-bold mt-2">
            <span>Total:</span>
            <span>S/ {{ pedido.SubTotal | number:'1.2-2' }}</span>
          </div>
        </div>

        <mat-form-field appearance="fill" class="w-full mt-4">
          <mat-label>Notas</mat-label>
          <textarea matInput rows="3" [(ngModel)]="pedido.Notas" name="notas"></textarea>
        </mat-form-field>
      </div>
    </div>
  </form>
</mat-dialog-content>

<mat-dialog-actions align="end">
  <button mat-button (click)="close()">Cancelar</button>
  <button mat-flat-button color="primary"
          [disabled]="form.invalid || !pedido.detalles?.length"
          (click)="savePedido()">
    Guardar Pedido
  </button>
</mat-dialog-actions>
