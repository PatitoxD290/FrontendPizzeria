<h2 mat-dialog-title>
  <mat-icon>swap_vert</mat-icon>
  {{ isFromSpecificRecord ? 'Registrar Movimiento' : 'Nuevo Movimiento de Stock' }}
</h2>

<mat-dialog-content class="dialog-content">
  <form [formGroup]="movimientoForm" class="movimiento-form">
    
    <!-- Buscar Insumo por Nombre (solo para nuevo movimiento) -->
    <mat-form-field appearance="outline" class="full-width" *ngIf="!isFromSpecificRecord">
      <mat-label>Buscar Insumo</mat-label>
      <input 
        type="text"
        matInput
        formControlName="insumoNombre"
        [matAutocomplete]="auto"
        placeholder="Escriba el nombre del insumo"
        [readonly]="loadingInsumos">
      <mat-icon matSuffix>search</mat-icon>
      <mat-autocomplete #auto="matAutocomplete" (optionSelected)="onInsumoSelected($event)" [displayWith]="displayInsumoFn">
        <mat-option *ngFor="let insumo of filteredInsumos | async" [value]="insumo.Nombre">
          <div class="insumo-option">
            <div class="insumo-header">
              <strong>{{ insumo.Nombre }}</strong>
              <span class="estado-badge" [class]="insumo.Estado === 'D' ? 'estado-disponible' : 'estado-agotado'">
                {{ insumo.Estado === 'D' ? 'Disponible' : 'Agotado' }}
              </span>
            </div>
            <span class="insumo-desc">{{ insumo.Descripcion }}</span>
            <small class="insumo-unidad">{{ insumo.Unidad_Med }}</small>
          </div>
        </mat-option>
      </mat-autocomplete>
      <mat-hint>Escriba para buscar todos los insumos</mat-hint>
      <mat-error *ngIf="formControls['insumoNombre'].hasError('required')">
        Debe seleccionar un insumo
      </mat-error>
    </mat-form-field>

    <!-- Mostrar información del insumo seleccionado (para movimientos desde registro específico) -->
    <div class="selected-insumo-info" *ngIf="isFromSpecificRecord && selectedInsumo">
      <mat-label>Insumo Seleccionado:</mat-label>
      <div class="insumo-details">
        <div class="info-row">
          <span><strong>{{ selectedInsumo.Nombre }}</strong></span>
          <span class="estado-badge" [class]="getEstadoInsumoClass()">
            {{ getEstadoInsumoText() }}
          </span>
        </div>
        <div class="insumo-meta">
          <span *ngIf="selectedInsumo.Descripcion">{{ selectedInsumo.Descripcion }}</span>
          <span>Unidad: {{ selectedInsumo.Unidad_Med }}</span>
        </div>
      </div>
    </div>

    <!-- Seleccionar Stock (si hay múltiples) -->
    <mat-form-field appearance="outline" class="full-width" *ngIf="stocksDisponibles.length > 1">
      <mat-label>Seleccionar Lote de Stock</mat-label>
      <mat-select formControlName="ID_Stock" (selectionChange)="onStockSelected($event)">
        <mat-option *ngFor="let stock of stocksDisponibles" [value]="stock.ID_Stock">
          Lote #{{ stock.ID_Stock }} - 
          Cantidad: {{ stock.Cantidad_Recibida }} - 
          Fecha: {{ stock.Fecha_Entrada | date:'shortDate' }}
          <span *ngIf="stock.Fecha_Vencimiento">
            - Vence: {{ stock.Fecha_Vencimiento | date:'shortDate' }}
          </span>
        </mat-option>
      </mat-select>
      <mat-error *ngIf="formControls['ID_Stock'].hasError('required')">
        Debe seleccionar un lote de stock
      </mat-error>
    </mat-form-field>

    <!-- Información del Stock Seleccionado -->
    <div class="stock-info" *ngIf="selectedStock && selectedInsumo">
      <mat-label>Información del Stock Seleccionado:</mat-label>
      <div class="stock-details">
        <div class="info-row">
          <span><strong>Insumo:</strong> {{ selectedInsumo.Nombre }}</span>
          <span class="estado-badge" [class]="getEstadoInsumoClass()">
            {{ getEstadoInsumoText() }}
          </span>
        </div>
        <div><strong>Stock Actual:</strong> {{ selectedStock.Cantidad_Recibida }} {{ selectedInsumo.Unidad_Med }}</div>
        <div><strong>Lote ID:</strong> {{ selectedStock.ID_Stock }}</div>
        <div *ngIf="selectedStock.Fecha_Vencimiento">
          <strong>Vencimiento:</strong> {{ selectedStock.Fecha_Vencimiento | date:'longDate' }}
        </div>
      </div>
    </div>

    <!-- Advertencia para insumos agotados -->
    <div class="warning-info" *ngIf="selectedInsumo && selectedInsumo.Estado === 'A'">
      <mat-icon>warning</mat-icon>
      <span>Este insumo está marcado como AGOTADO. Verifique la disponibilidad antes de realizar movimientos.</span>
    </div>

    <!-- Tipo de Movimiento -->
    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Tipo de Movimiento</mat-label>
      <mat-select formControlName="Tipo_Mov">
        <mat-option *ngFor="let tipo of tiposMovimiento" [value]="tipo">
          {{ tipo }}
        </mat-option>
      </mat-select>
      <mat-error *ngIf="formControls['Tipo_Mov'].hasError('required')">
        El tipo de movimiento es requerido
      </mat-error>
    </mat-form-field>

    <!-- Cantidad -->
    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Cantidad</mat-label>
      <input 
        matInput 
        formControlName="Cantidad" 
        type="number"
        placeholder="Ingrese la cantidad"
        min="1">
      <mat-icon matSuffix>format_list_numbered</mat-icon>
      <span matSuffix *ngIf="selectedInsumo">{{ selectedInsumo.Unidad_Med }}</span>
      <mat-error *ngIf="formControls['Cantidad'].hasError('required')">
        La cantidad es requerida
      </mat-error>
      <mat-error *ngIf="formControls['Cantidad'].hasError('min')">
        La cantidad debe ser mayor a 0
      </mat-error>
      <mat-hint *ngIf="selectedStock && formControls['Tipo_Mov'].value === 'Salida'">
        Stock disponible: {{ selectedStock.Cantidad_Recibida }}
      </mat-hint>
    </mat-form-field>

    <!-- Motivo -->
    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Motivo (Opcional)</mat-label>
      <textarea 
        matInput 
        formControlName="Motivo" 
        placeholder="Describa el motivo del movimiento (opcional)"
        rows="3">
      </textarea>
    </mat-form-field>

    <!-- Información del usuario (solo lectura) -->
    <div class="user-info" *ngIf="usuarioLogueado">
      <mat-label>Usuario que registra:</mat-label>
      <div class="user-details">
        <strong>{{ usuarioLogueado.nombre }}</strong>
        <span>(ID: {{ usuarioLogueado.ID_Usuario }})</span>
      </div>
    </div>

  </form>
</mat-dialog-content>

<mat-dialog-actions align="end" class="dialog-actions">
  <button 
    mat-button 
    (click)="onCancel()" 
    [disabled]="loading">
    Cancelar
  </button>
  <button 
    mat-raised-button 
    color="primary" 
    (click)="onSubmit()" 
    [disabled]="loading || movimientoForm.invalid">
    <span *ngIf="loading" class="button-loading">
      <mat-spinner diameter="16"></mat-spinner>
      Procesando...
    </span>
    <span *ngIf="!loading">
      Registrar Movimiento
    </span>
  </button>
</mat-dialog-actions>