<div class="container-fluid p-4">
  
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4 header-section">
    <div>
      <h1 class="mat-headline-5 mb-0">Historial de Pedidos</h1>
      <p class="text-secondary mb-0">Monitoreo de Ã³rdenes en tiempo real</p>
    </div>
    <div class="d-flex gap-2">
      <button mat-stroked-button color="primary" (click)="refrescarManual()" [disabled]="loading">
        <mat-icon [class.spin]="loading">refresh</mat-icon> Actualizar
      </button>
      <button mat-raised-button color="accent" (click)="exportarPDF()">
        <mat-icon>picture_as_pdf</mat-icon> PDF
      </button>
    </div>
  </div>

  <!-- Filtros -->
  <div class="filters-container mat-elevation-z1 mb-4">
    <mat-form-field appearance="outline" class="search-field">
      <mat-label>Buscar pedido</mat-label>
      <input matInput [(ngModel)]="searchTerm" (keyup)="applyFilter()" placeholder="ID, Cliente, Nota...">
      <mat-icon matSuffix>search</mat-icon>
    </mat-form-field>

    <mat-form-field appearance="outline" class="date-field">
      <mat-label>Desde</mat-label>
      <input matInput [matDatepicker]="picker1" [(ngModel)]="fechaInicio" (dateChange)="applyFilter()">
      <mat-datepicker-toggle matSuffix [for]="picker1"></mat-datepicker-toggle>
      <mat-datepicker #picker1></mat-datepicker>
    </mat-form-field>

    <mat-form-field appearance="outline" class="date-field">
      <mat-label>Hasta</mat-label>
      <input matInput [matDatepicker]="picker2" [(ngModel)]="fechaFin" (dateChange)="applyFilter()">
      <mat-datepicker-toggle matSuffix [for]="picker2"></mat-datepicker-toggle>
      <mat-datepicker #picker2></mat-datepicker>
    </mat-form-field>

    <button mat-icon-button color="warn" *ngIf="searchTerm || fechaInicio || fechaFin" (click)="limpiarFiltros()" matTooltip="Limpiar filtros">
      <mat-icon>filter_alt_off</mat-icon>
    </button>
  </div>

  <!-- Loading -->
  <div *ngIf="loading" class="loading-container">
    <mat-spinner diameter="50"></mat-spinner>
    <p class="mt-3">Cargando pedidos...</p>
  </div>

  <!-- Tabla -->
  <div class="mat-elevation-z8 table-container" [hidden]="loading">
    <table mat-table [dataSource]="dataSource" matSort>

      <!-- ID -->
      <ng-container matColumnDef="ID_Pedido">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> ID </th>
        <td mat-cell *matCellDef="let row"> 
          <span class="id-badge">#{{row.ID_Pedido}}</span> 
        </td>
      </ng-container>

      <!-- Cliente -->
      <ng-container matColumnDef="Cliente">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Cliente </th>
        <td mat-cell *matCellDef="let row" class="fw-medium"> 
          {{ getNombreCliente(row.ID_Cliente) }} 
        </td>
      </ng-container>

      <!-- Notas -->
      <ng-container matColumnDef="Notas">
        <th mat-header-cell *matHeaderCellDef> Notas </th>
        <td mat-cell *matCellDef="let row" class="text-muted small text-truncate" style="max-width: 200px;">
          {{ row.Notas || '---' }}
        </td>
      </ng-container>

      <!-- Total -->
      <ng-container matColumnDef="Total">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Total </th>
        <td mat-cell *matCellDef="let row" class="fw-bold text-primary"> 
          S/ {{ (row.SubTotal || 0) | number:'1.2-2' }} 
        </td>
      </ng-container>

      <!-- Estado -->
      <ng-container matColumnDef="Estado">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Estado </th>
        <td mat-cell *matCellDef="let row">
          <span [class]="'status-pill ' + getEstadoClass(row.Estado_P)">
            {{ getEstadoLabel(row.Estado_P) }}
          </span>
        </td>
      </ng-container>

      <!-- Fecha -->
      <ng-container matColumnDef="Fecha">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Fecha </th>
        <td mat-cell *matCellDef="let row" class="text-secondary small"> 
          {{ row.Fecha_Registro | date:'dd/MM/yy HH:mm' }} 
        </td>
      </ng-container>

      <!-- Acciones -->
      <ng-container matColumnDef="acciones">
        <th mat-header-cell *matHeaderCellDef class="text-center"> Detalles </th>
        <td mat-cell *matCellDef="let row" class="text-center">
          <button mat-icon-button color="primary" (click)="viewDetallePedido(row)" matTooltip="Ver productos">
            <mat-icon>visibility</mat-icon>
          </button>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="hover-row"></tr>

      <!-- No Data -->
      <tr class="mat-row" *matNoDataRow>
        <td class="mat-cell text-center py-4" colspan="7">
          No se encontraron pedidos con los filtros actuales.
        </td>
      </tr>
    </table>

    <mat-paginator [pageSizeOptions]="[10, 20, 50]" showFirstLastButtons></mat-paginator>
  </div>
</div>