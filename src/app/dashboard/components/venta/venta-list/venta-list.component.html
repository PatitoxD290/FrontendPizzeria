<mat-card class="venta-card">
  <mat-card-title class="titulo">
    <mat-icon color="primary">receipt_long</mat-icon>
    Historial de Ventas
    <span class="subtitle">Consulta y reimprime comprobantes</span>
  </mat-card-title>

  <!-- Filtros -->
  <div class="filtros">
    <mat-form-field appearance="outline" class="search-field">
      <mat-label>Buscar por Cliente o ID</mat-label>
      <input matInput [(ngModel)]="filtroTexto" (keyup)="aplicarFiltros()" placeholder="Ej: Juan Perez">
      <mat-icon matSuffix>search</mat-icon>
    </mat-form-field>

    <mat-form-field appearance="outline" class="date-field">
      <mat-label>Desde</mat-label>
      <input matInput [matDatepicker]="pickerInicio" [(ngModel)]="fechaInicio" (dateChange)="aplicarFiltros()">
      <mat-datepicker-toggle matSuffix [for]="pickerInicio"></mat-datepicker-toggle>
      <mat-datepicker #pickerInicio></mat-datepicker>
    </mat-form-field>

    <mat-form-field appearance="outline" class="date-field">
      <mat-label>Hasta</mat-label>
      <input matInput [matDatepicker]="pickerFin" [(ngModel)]="fechaFin" (dateChange)="aplicarFiltros()">
      <mat-datepicker-toggle matSuffix [for]="pickerFin"></mat-datepicker-toggle>
      <mat-datepicker #pickerFin></mat-datepicker>
    </mat-form-field>

    <button mat-stroked-button color="warn" (click)="limpiarFiltros()" *ngIf="filtroTexto || fechaInicio || fechaFin">
      <mat-icon>filter_alt_off</mat-icon> Limpiar
    </button>

    <span class="spacer"></span>

    <button mat-raised-button color="primary" (click)="exportarPDF()" matTooltip="Generar reporte PDF" class="export-btn">
      <mat-icon>picture_as_pdf</mat-icon> Exportar PDF
    </button>
  </div>

  <!-- Loading -->
  <div *ngIf="loading" class="loading-container">
    <mat-spinner diameter="50"></mat-spinner>
    <p class="mt-3">Cargando ventas...</p>
  </div>

  <!-- Tabla -->
  <div class="tabla-container" [hidden]="loading">
    <table mat-table [dataSource]="dataSource" matSort class="mat-elevation-z8">

      <!-- ID -->
      <ng-container matColumnDef="ID_Venta">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> ID </th>
        <td mat-cell *matCellDef="let row" class="text-secondary"> #{{row.ID_Venta}} </td>
      </ng-container>

      <!-- Cliente -->
      <ng-container matColumnDef="Cliente">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Cliente </th>
        <td mat-cell *matCellDef="let row" class="fw-medium"> 
          {{ row.Cliente_Nombre || 'Cliente General' }} 
        </td>
      </ng-container>

      <!-- Tipo Comprobante -->
      <ng-container matColumnDef="Tipo">
        <th mat-header-cell *matHeaderCellDef> Tipo </th>
        <td mat-cell *matCellDef="let row">
          <mat-chip-option [color]="row.ID_Tipo_Venta === 2 ? 'accent' : 'primary'" disabled>
            {{ getTipoVentaLabel(row) }}
          </mat-chip-option>
        </td>
      </ng-container>

      <!-- MÃ©todo Pago -->
      <ng-container matColumnDef="Metodo">
        <th mat-header-cell *matHeaderCellDef> Pago </th>
        <td mat-cell *matCellDef="let row"> {{ getMetodoPagoLabel(row) }} </td>
      </ng-container>

      <!-- Total -->
      <ng-container matColumnDef="Total">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Total </th>
        <td mat-cell *matCellDef="let row" class="text-success fw-bold"> 
          S/ {{ row.Total | number:'1.2-2' }} 
        </td>
      </ng-container>

      <!-- Fecha -->
      <ng-container matColumnDef="Fecha">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Fecha </th>
        <td mat-cell *matCellDef="let row" class="text-muted small"> 
          {{ row.Fecha_Registro | date:'dd/MM/yyyy HH:mm' }} 
        </td>
      </ng-container>

      <!-- Acciones -->
      <ng-container matColumnDef="acciones">
        <th mat-header-cell *matHeaderCellDef class="text-center"> Comprobante </th>
        <td mat-cell *matCellDef="let row" class="text-center acciones-cell">
          <button mat-icon-button color="primary" 
                  (click)="generarPDFVenta(row)" 
                  [disabled]="cargandoPDF === row.ID_Venta"
                  matTooltip="Imprimir Comprobante"
                  class="pdf-button">
            <mat-icon *ngIf="cargandoPDF !== row.ID_Venta">print</mat-icon>
            <mat-spinner *ngIf="cargandoPDF === row.ID_Venta" diameter="20"></mat-spinner>
          </button>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="hover-row"></tr>

      <!-- No Data -->
      <tr class="mat-row" *matNoDataRow>
        <td class="mat-cell text-center py-4" colspan="7">
          No se encontraron ventas que coincidan con los filtros.
        </td>
      </tr>
    </table>

    <mat-paginator [pageSizeOptions]="[10, 25, 50]" showFirstLastButtons></mat-paginator>
  </div>
</mat-card>